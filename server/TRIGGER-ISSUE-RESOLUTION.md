# Database Trigger Issue Resolution Guide\n\n## Problem Description\n\nThe MySalary application was experiencing incorrect Net Worth calculations where scheduled transactions were being included in account balances, even though they should only affect balances when they are confirmed (status changed to 'posted').\n\n## Root Cause Analysis\n\n### The Problematic Trigger\n\nThe issue was caused by a PostgreSQL database trigger `update_balance_trigger` that was created in migration `20250703205616-add-audit-and-constraints.js`. This trigger automatically updated account balances for ALL transaction operations (INSERT, UPDATE, DELETE) without checking the transaction status.\n\n```sql\n-- Problematic trigger function\nCREATE OR REPLACE FUNCTION update_account_balance()\nRETURNS TRIGGER AS $$\nBEGIN\n    -- This function updated balances WITHOUT checking transaction status!\n    -- It treated scheduled transactions the same as posted transactions\nEND;\n$$ LANGUAGE plpgsql;\n\nCREATE TRIGGER update_balance_trigger\n    AFTER INSERT OR UPDATE OR DELETE ON \"Transactions\"\n    FOR EACH ROW EXECUTE FUNCTION update_account_balance();\n```\n\n### Symptoms Observed\n\n1. **Incorrect Net Worth Display**: When users created scheduled transactions, the Total Net Worth immediately reflected the transaction amount, even though the account balance should remain unchanged until the transaction is confirmed.\n\n2. **Double Balance Updates**: When confirming scheduled transactions, balances were updated twice:\n   - Once by the application logic (correct)\n   - Once by the database trigger (incorrect duplicate)\n\n3. **Balance Discrepancies**: Account balances accumulated errors over time due to scheduled transactions being incorrectly included.\n\n### Example Scenario\n\n```\nUser has account with 1000 EUR\nUser creates scheduled transaction: -10 EUR expense\n\nExpected behavior:\n- Account balance remains: 1000 EUR\n- Net Worth shows: 1000 EUR\n- Transaction shows as scheduled for future date\n\nActual behavior (with bug):\n- Account balance becomes: 990 EUR (updated by trigger)\n- Net Worth shows: 990 EUR\n- But transaction is still scheduled, not posted\n```\n\n## Solution Implementation\n\n### Step 1: Remove Problematic Trigger\n\nMigration `20250720000000-remove-balance-trigger.js` was created to remove the trigger:\n\n```sql\nDROP TRIGGER IF EXISTS update_balance_trigger ON \"Transactions\";\nDROP FUNCTION IF EXISTS update_account_balance();\n```\n\n### Step 2: Recalculate Account Balances\n\nSince the trigger may have corrupted existing balances, all account balances need to be recalculated based only on posted transactions.\n\n### Step 3: Add Validation to Net Worth API\n\nThe Net Worth calculation endpoint was enhanced with validation capabilities to detect and correct balance discrepancies.\n\n## Resolution Steps\n\n### 1. Check for Remaining Triggers\n\n```bash\nnode check-and-fix-trigger.js\n```\n\nThis script will:\n- Check if the problematic trigger still exists\n- Remove it if found\n- Check for other potentially problematic triggers\n- Provide a detailed report\n\n### 2. Validate Current State\n\n```bash\n# Check all users\nnode validate-networth-integrity.js\n\n# Check specific user\nnode validate-networth-integrity.js --user=8\n```\n\nThis will identify any accounts with balance discrepancies without making changes.\n\n### 3. Fix Balance Discrepancies\n\n```bash\n# Dry run to see what would be changed\nnode fix-account-balances.js --dry-run\n\n# Fix all accounts\nnode fix-account-balances.js\n\n# Fix specific user's accounts\nnode fix-account-balances.js --user=8\n```\n\n### 4. Verify Net Worth Calculation\n\n```bash\n# Test the Net Worth API with validation\ncurl \"http://localhost:3002/api/networth?validate=true\" \\\n  -H \"Authorization: Bearer YOUR_TOKEN\"\n```\n\nThe `validate=true` parameter enables balance integrity checking in the API response.\n\n## Prevention Measures\n\n### 1. Application-Level Balance Management\n\nBalance updates are now handled exclusively by the application logic in `routes/transactions.js`:\n\n```javascript\n// Only update balance for posted transactions\nconst shouldUpdateBalance = transaction.status === 'posted';\nif (shouldUpdateBalance) {\n  // Update account balance logic\n}\n```\n\n### 2. Status-Aware Transaction Processing\n\nAll transaction operations now properly check the status:\n- `scheduled`: Transaction exists but doesn't affect balance\n- `posted`: Transaction affects account balance and Net Worth\n\n### 3. Enhanced Validation\n\nThe Net Worth API now includes optional validation that can:\n- Recalculate expected balances from posted transactions\n- Compare with stored balances\n- Return corrected values if discrepancies are found\n- Log warnings for manual review\n\n## Verification Commands\n\n### Check Database State\n\n```sql\n-- Verify no problematic triggers exist\nSELECT trigger_name, event_manipulation, event_object_table \nFROM information_schema.triggers \nWHERE event_object_table = 'Transactions';\n\n-- Check for balance-related functions\nSELECT routine_name, routine_type \nFROM information_schema.routines \nWHERE routine_name LIKE '%balance%';\n```\n\n### Test Transaction Flow\n\n1. Create a scheduled transaction\n2. Verify account balance doesn't change\n3. Verify Net Worth doesn't change\n4. Confirm the transaction\n5. Verify balance and Net Worth update correctly\n\n### Monitor for Issues\n\n```bash\n# Regular integrity check (recommended weekly)\nnode validate-networth-integrity.js\n\n# Check specific user if they report issues\nnode validate-networth-integrity.js --user=USER_ID\n```\n\n## Files Modified/Created\n\n1. **server/check-and-fix-trigger.js** - Diagnostic and repair script for triggers\n2. **server/fix-account-balances.js** - Enhanced balance recalculation with dry-run mode\n3. **server/validate-networth-integrity.js** - Comprehensive integrity validation\n4. **server/routes/networth.js** - Added validation mode to Net Worth API\n5. **server/TRIGGER-ISSUE-RESOLUTION.md** - This documentation\n\n## Success Criteria\n\n✅ No problematic database triggers exist  \n✅ All account balances reflect only posted transactions  \n✅ Scheduled transactions don't affect Net Worth display  \n✅ Balance updates only occur when transactions are confirmed  \n✅ Net Worth API validation shows no discrepancies  \n\n## Emergency Recovery\n\nIf issues persist or new problems are discovered:\n\n1. **Immediate**: Run balance recalculation for affected users\n   ```bash\n   node fix-account-balances.js --user=AFFECTED_USER_ID\n   ```\n\n2. **Investigation**: Use validation script to identify scope\n   ```bash\n   node validate-networth-integrity.js\n   ```\n\n3. **Communication**: Inform affected users that balances are being corrected\n\n4. **Monitoring**: Enable Net Worth API validation temporarily\n   ```\n   GET /api/networth?validate=true\n   ```\n\n## Contact\n\nFor questions about this resolution or if new balance-related issues are discovered, refer to this document and the diagnostic scripts provided.\n\n**Last Updated**: July 20, 2025  \n**Resolution Status**: ✅ Complete  \n**Affected Versions**: All versions with migration 20250703205616  