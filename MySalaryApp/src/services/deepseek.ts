interface DeepSeekMessage {
  role: 'system' | 'user' | 'assistant';
  content: string;
}

interface DeepSeekResponse {
  id: string;
  object: string;
  created: number;
  model: string;
  choices: Array<{
    index: number;
    message: {
      role: string;
      content: string;
    };
    finish_reason: string;
  }>;
  usage: {
    prompt_tokens: number;
    completion_tokens: number;
    total_tokens: number;
  };
}

const DEEPSEEK_API_KEY: string = 'sk-cb19875cb7a74140822b7f93fd4ee69b';
const DEEPSEEK_API_URL = 'https://api.deepseek.com/chat/completions';

const FINANCIAL_SYSTEM_PROMPT = `–¢—ã ‚Äî –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç, –≤—ã—Å—Ç—É–ø–∞—é—â–∏–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–º —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–º –ø–æ–º–æ—â–Ω–∏–∫–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
–¢–≤–æ—è –∑–æ–Ω–∞ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ —Å—Ç—Ä–æ–≥–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∞ –≤–æ–ø—Ä–æ—Å–∞–º–∏ –ª–∏—á–Ω—ã—Ö —Ñ–∏–Ω–∞–Ω—Å–æ–≤, –±—é–¥–∂–µ—Ç–∞ –∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–≥–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è.

üéØ –¶–ï–õ–¨
‚Äî –ü–æ–º–æ–≥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å–æ–±–∏—Ä–∞—Ç—å, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞—Ç—å –∏ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –µ–≥–æ –¥–æ—Ö–æ–¥—ã, —Ä–∞—Å—Ö–æ–¥—ã, –∞–∫—Ç–∏–≤—ã –∏ –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞.
‚Äî –î–∞–≤–∞—Ç—å –ø–æ–Ω—è—Ç–Ω—ã–µ, –æ–±–æ—Å–Ω–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –±—é–¥–∂–µ—Ç–∞, –ø–æ—Å—Ç–∞–Ω–æ–≤–∫–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö —Ü–µ–ª–µ–π –∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—é —ç—Ç–∏—Ö —Ü–µ–ª–µ–π.
‚Äî –û—Ç–≤–µ—á–∞—Ç—å —Ç–æ–ª—å–∫–æ –Ω–∞ —Ç–µ–º—ã, –Ω–∞–ø—Ä—è–º—É—é —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å —Ñ–∏–Ω–∞–Ω—Å–∞–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

üìã –ß–¢–û –î–ï–õ–ê–¢–¨
1. **–°–±–æ—Ä –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞**
   ‚Ä¢ –í–µ–∂–ª–∏–≤–æ —É—Ç–æ—á–Ω—è—Ç—å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–µ—Ç–∞–ª–∏ (–≤–∞–ª—é—Ç–∞, –ø–µ—Ä–∏–æ–¥, —Ü–µ–ª–∏, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è).
   ‚Ä¢ –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –Ω–µ–ø–æ–ª–Ω—ã–µ, –ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å —É–¥–æ–±–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –¥–ª—è –∏—Ö –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è (—Ç–∞–±–ª–∏—Ü–∞, —Å–ø–∏—Å–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∏ —Ç. –¥.).

2. **–ê–Ω–∞–ª–∏–∑ –∏ –≤—ã–≤–æ–¥—ã**
   ‚Ä¢ –°—Ç—Ä–æ–∏—Ç—å –æ—Ç—á—ë—Ç—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º —Ä–∞—Å—Ö–æ–¥–æ–≤/–¥–æ—Ö–æ–¥–æ–≤, –≤—ã—è–≤–ª—è—Ç—å —Ç—Ä–µ–Ω–¥—ã –∏ –∞–Ω–æ–º–∞–ª–∏–∏.
   ‚Ä¢ –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã (savings rate, debt-to-income, —Ñ–∏–Ω–∞–Ω—Å–æ–≤—É—é –ø–æ–¥—É—à–∫—É) –∏ –æ–±—ä—è—Å–Ω—è—Ç—å –∏—Ö –∑–Ω–∞—á–µ–Ω–∏–µ.
   ‚Ä¢ –î–∞–≤–∞—Ç—å –ø–æ—à–∞–≥–æ–≤—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏: –≥–¥–µ —Å–æ–∫—Ä–∞—Ç–∏—Ç—å —Ç—Ä–∞—Ç—ã, –∫–∞–∫ —É–≤–µ–ª–∏—á–∏—Ç—å –¥–æ—Ö–æ–¥, –∫–∞–∫ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è—Ç—å —Å–≤–æ–±–æ–¥–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞.

3. **–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –±—é–¥–∂–µ—Ç–∞**
   ‚Ä¢ –ü—Ä–µ–¥–ª–∞–≥–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –±—é–¥–∂–µ—Ç–∞ (50/30/20, zero-based, envelope-method –∏ —Ç. –¥.) –∏ –ø–æ–º–æ–≥–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –∏—Ö –ø–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
   ‚Ä¢ –°—Ç—Ä–æ–∏—Ç—å –ø—Ä–æ–≥–Ω–æ–∑—ã –∫—ç—à-—Ñ–ª–æ—É –∏ —Å—Ü–µ–Ω–∞—Ä–∏–∏ ¬´—á—Ç–æ –±—É–¥–µ—Ç –µ—Å–ª–∏¬ª.

4. **–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞**
   ‚Ä¢ –û–±—ä—è—Å–Ω—è—Ç—å —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø–æ–Ω—è—Ç–∏—è –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.
   ‚Ä¢ –ü—Ä–µ–¥–ª–∞–≥–∞—Ç—å —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ —á–µ–∫-–∞–ø—ã, –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –∏ –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞.

üöß –ß–¢–û –ù–ï –î–ï–õ–ê–¢–¨
‚Äî –ù–µ –¥–∞–≤–∞—Ç—å –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω—ã—Ö —Å–æ–≤–µ—Ç–æ–≤, —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –ø–æ –ø–æ–∫—É–ø–∫–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ü–µ–Ω–Ω—ã—Ö –±—É–º–∞–≥ –∏–ª–∏ –Ω–∞–ª–æ–≥–æ–≤—ã—Ö —Å—Ö–µ–º; –≤–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ —É–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ —Å –ª–∏—Ü–µ–Ω–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º.
‚Äî –ù–µ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –Ω–∞ —Ç–µ–º—ã, –Ω–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –ª–∏—á–Ω—ã–º–∏ —Ñ–∏–Ω–∞–Ω—Å–∞–º–∏ (–∑–¥–æ—Ä–æ–≤—å–µ, –∫–∞—Ä—å–µ—Ä–∞, –ø—Å–∏—Ö–æ–ª–æ–≥–∏—è, –ø–æ–ª–∏—Ç–∏–∫–∞ –∏ —Ç. –¥.). –í —Ç–∞–∫–∏—Ö —Å–ª—É—á–∞—è—Ö –∫–æ—Ä–æ—Ç–∫–æ –∏–∑–≤–∏–Ω—è—Ç—å—Å—è –∏ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å —Ä–∞–∑–≥–æ–≤–æ—Ä –≤ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–µ —Ä—É—Å–ª–æ.
‚Äî –ù–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, –Ω–µ –Ω—É–∂–Ω—ã–µ –¥–ª—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ (–ø–∞—Å–ø–æ—Ä—Ç, –∫–∞—Ä—Ç—ã, –ø–∞—Ä–æ–ª–∏).

üõ°Ô∏è –¢–û–ù
‚Äî –î—Ä—É–∂–µ–ª—é–±–Ω—ã–π –∏ —É–≤–∞–∂–∏—Ç–µ–ª—å–Ω—ã–π, –Ω–æ –¥–µ–ª–æ–≤–æ–π.
‚Äî –ß—ë—Ç–∫–∏–µ, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã, –º–∏–Ω–∏–º—É–º –∂–∞—Ä–≥–æ–Ω–∞ –∏–ª–∏, –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏, –µ–≥–æ –ø–æ—è—Å–Ω–µ–Ω–∏–µ.
‚Äî –ü—Ä–∏ —Ü–∏—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –Ω–æ—Ä–º–∞—Ç–∏–≤–æ–≤ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —É–∫–∞–∑—ã–≤–∞—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫ –∏ –¥–∞—Ç—É.

üîê –ö–û–ù–§–ò–î–ï–ù–¶–ò–ê–õ–¨–ù–û–°–¢–¨
‚Äî –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞—Ç—å, —á—Ç–æ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —Å—Ç—Ä–æ–≥–æ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω—ã.
‚Äî –ü–µ—Ä–µ—Ñ—Ä–∞–∑–∏—Ä–æ–≤–∞—Ç—å –≤—Ö–æ–¥—è—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è, —Å–æ–¥–µ—Ä–∂–∞—â–∏–µ –ª–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, –ø—Ä–µ–∂–¥–µ —á–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏—Ö –≤ –æ—Ç–≤–µ—Ç–µ.

–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥–Ω–∏–º–∞–µ—Ç –Ω–µ—Ü–µ–ª–µ–≤—É—é —Ç–µ–º—É ‚áí
1) –ö–æ—Ä–æ—Ç–∫–æ –∏–∑–≤–∏–Ω–∏—Ç—å—Å—è.
2) –ù–∞–ø–æ–º–Ω–∏—Ç—å, —á—Ç–æ –º–æ–≥—É –ø–æ–º–æ—á—å —Ç–æ–ª—å–∫–æ –ø–æ –≤–æ–ø—Ä–æ—Å–∞–º –ª–∏—á–Ω—ã—Ö —Ñ–∏–Ω–∞–Ω—Å–æ–≤.
3) –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–º—É –æ–±—Å—É–∂–¥–µ–Ω–∏—é.

–û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ, –±—É–¥—å –ª–∞–∫–æ–Ω–∏—á–Ω—ã–º –∏ –ø–æ–ª–µ–∑–Ω—ã–º.
–°–µ–≥–æ–¥–Ω—è—à–Ω—è—è –¥–∞—Ç–∞: ${new Date().toLocaleDateString()}`;


class DeepSeekService {
  private messages: DeepSeekMessage[] = [];

  constructor() {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å —Å–∏—Å—Ç–µ–º–Ω—ã–º –ø—Ä–æ–º–ø—Ç–æ–º
    this.messages = [
      {
        role: 'system',
        content: FINANCIAL_SYSTEM_PROMPT,
      },
    ];
  }

  async sendMessage(userMessage: string): Promise<string> {
    // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    this.messages.push({
      role: 'user',
      content: userMessage,
    });

    try {
      const response = await fetch(DEEPSEEK_API_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${DEEPSEEK_API_KEY}`,
        },
        body: JSON.stringify({
          model: 'deepseek-chat',
          messages: this.messages,
          max_tokens: 1000,
          temperature: 0.7,
        }),
      });

      if (!response.ok) {
        const errorData = await response.json().catch(() => null);
        throw new Error(`DeepSeek API error: ${response.status} - ${errorData?.error?.message || 'Unknown error'}`);
      }

      const data: DeepSeekResponse = await response.json();

      if (!data.choices || data.choices.length === 0) {
        throw new Error('No response from DeepSeek API');
      }

      const aiMessage = data.choices[0].message.content;

      // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç AI –≤ –∏—Å—Ç–æ—Ä–∏—é
      this.messages.push({
        role: 'assistant',
        content: aiMessage,
      });

      return aiMessage;
    } catch (error) {
      // –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞
      this.messages.pop();
      
      if (error instanceof Error) {
        throw error;
      }
      throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç AI –ø–æ–º–æ—â–Ω–∏–∫–∞');
    }
  }

  clearHistory(): void {
    this.messages = [
      {
        role: 'system',
        content: FINANCIAL_SYSTEM_PROMPT,
      },
    ];
  }

  getMessagesCount(): number {
    return this.messages.length - 1; // Excluding system message
  }

  generateMessageId(): string {
    return Date.now().toString() + Math.random().toString(36).substr(2, 9);
  }
}

export const deepSeekService = new DeepSeekService();
